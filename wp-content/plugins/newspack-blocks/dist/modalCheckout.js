(()=>{"use strict";const e=(e,t={})=>({...t,action:e}),t=["action","action_type","amount","currency","product_id","product_type","variation_id","variation_ids","is_variable","is_grouped","child_ids","price_summary","newspack_popup_id","gate_post_id","recurrence","referrer"],o=(e,o="np_modal_checkout_interaction")=>{if("function"==typeof window.gtag&&e){const c={};for(const o of t)e[o]&&("boolean"==typeof e[o]?e[o]=e[o]?"yes":"no":"true"===e[o]?e[o]="yes":"false"===e[o]&&(e[o]="no"),c[o]=e[o].toString());window.gtag("event",o,c)}};function c(e){"undefined"!=typeof document&&"function"==typeof e&&("complete"!==document.readyState&&"interactive"!==document.readyState?document.addEventListener("DOMContentLoaded",e):e())}function n(e){const t="string"==typeof e?document.getElementById(e):e;if(!t)return console.warn("No container found for checkout data"),{};let o={};if("FORM"===t.tagName){const e=new FormData(t);o=Object.fromEntries(e)}const c=t.dataset.checkout;if(!c)return console.warn("No checkout data found"),o;try{o={...o,...JSON.parse(c)}}catch(e){console.warn("Error parsing checkout data")}const n=new URL(t.ownerDocument.defaultView.location.href);return n.searchParams.get("action_type")&&(o.action_type=n.searchParams.get("action_type")),o}const i=(t="continue")=>{if("function"!=typeof window.gtag)return;const{action_type:c,amount:i,currency:r,product_id:s,product_type:a,recurrence:d,referrer:u,variation_id:l="",gate_post_id:p="",newspack_popup_id:_=""}=n("modal-checkout-product-details"),h={action_type:c,amount:i,currency:r,product_id:s,product_type:a,recurrence:d,referrer:u};l&&(h.variation_id=l),p&&(h.gate_post_id=p),_&&(h.newspack_popup_id=_);const m=e(t,h);o(m)};var r;r=jQuery,c(()=>{if(!r)return void console.warn("jQuery is not available.");const t=document.querySelector("#newspack_modal_checkout_container"),s=newspackBlocksModalCheckout.newspack_class_prefix,a=new CustomEvent("checkout-ready"),d=new CustomEvent("checkout-complete"),u=new CustomEvent("checkout-cancel"),l=new CustomEvent("checkout-place-order-start"),p=new CustomEvent("checkout-place-order-success"),_=new CustomEvent("checkout-place-order-error"),h=new CustomEvent("checkout-place-order-critical-error");function m(){r(".woocommerce-notices-wrapper").empty(),r(`.woocommerce-NoticeGroup-checkout, .${s}__inline-error, .woocommerce-error, .woocommerce-message, .wc-block-components-notice-banner`).remove()}function f(i=!0){t.checkoutReady=!0,t.dispatchEvent(a),i&&c(function(){if("function"!=typeof window.gtag)return;const t=n("modal-checkout-product-details"),c=e("loaded",t);o(c)})}if(newspackBlocksModalCheckout.is_checkout_complete)(()=>{if("function"!=typeof window.gtag)return;const t=n("modal-checkout-product-details"),c=e("form_submission_success",t);o(c)})(),t&&(t.checkoutComplete=!0,t.dispatchEvent(d));else{function g(){r("#wcpay-express-checkout-button-separator, #wc-stripe-payment-request-button-separator, #wc-stripe-express-checkout-button-separator").after('<div class="newspack-ui__word-divider">'+newspackBlocksModalCheckout.divider_text+"</div>");let c=[];const a=r("form.checkout"),d=r("#checkout_cancel");if(d.length&&d.on("click",function(){t.dispatchEvent(u)}),!a.length)return console.warn("Checkout form is not available"),void f();const g=r("form.modal_checkout_coupon"),w=r("form.modal_checkout_nyp"),v=r("#checkout_continue"),b=r("#customer_details"),y=r("#after_customer_details"),C=r(".newspack-wcsg--wrapper");function E(){const e=r('input[name="payment_method"]:checked').val();r(".wc_payment_method").removeClass("selected"),r(".wc_payment_method.payment_method_"+e).addClass("selected")}r('input[name="payment_method"]').change(E),r(document).on("payment_method_selected",E),r(document).on("updated_checkout",E),E();let x=!1;function M(){let e;if(r.ajax({url:newspackBlocksModalCheckout.ajax_url,method:"POST",async:!1,data:{action:"get_cart_total"},success:t=>{e=t}}),e)return e}if(a.on("checkout_place_order",function(){x||(x=!0,t.dispatchEvent(l))}),function(e,t){e.checkoutPlaceOrderProcessing?t():e.addEventListener("checkout-place-order-processing",t)}(t,function(){x&&(a.is(".processing")||(x=!1,t.dispatchEvent(_)))}),a.on("checkout_place_order_success",function(){x=!1,t.dispatchEvent(p)}),r(document.body).on("checkout_error",function(e,o){x&&(x=!1,o&&o.indexOf(newspackBlocksModalCheckout.labels.critical_error)>=0?t.dispatchEvent(h):t.dispatchEvent(_))}),a.on("update_checkout",function(){x&&(x=!1,t.dispatchEvent(_))}),r(document).on("updated_checkout",function(){r("#payment .wc_payment_methods").length?r("#after_customer_details > h3").show():r("#after_customer_details > h3").hide()}),r(document).on("updated_checkout",function(){const e=r(".order-review-wrapper");if(!e.length)return;const t=e.find("table");t.is(".empty")?e.addClass("hidden"):(t.unblock(),e.removeClass("hidden"));const o=r("#after_customer_details").hasClass("transaction-details-expanded"),c=r(".payment_methods");if(c.length){const t=e.clone();o&&r('[id="order_review_heading"]',t).attr("aria-expanded","true"),r(".order-review-wrapper").remove(),c.after(t)}else o||e.find("#order_review_heading").trigger("click")}),r(document).on("click","#order_review_heading",function(){r(this).attr("aria-expanded",function(e,t){return"false"===t?"true":"false"}),r("#after_customer_details").toggleClass("transaction-details-expanded")}),r(document).on("updated_checkout",function(){let e=newspackBlocksModalCheckout.labels.complete_button;if(e){if(r("#place_order").has(r("span.cart-price"))){const t=r("<div>"+e+"</div>");t.find(".cart-price").html(M,function(){return this.childNodes}),e=t.html()}r("#place_order").html(e),r("#place_order_clone").html(e)}}),C.length){const e=C.find(".newspack-wcsg--gift-toggle input"),t=C.find(".newspack-wcsg--gift-email");e.on("change",function(){e.is(":checked")?t.addClass("visible"):t.removeClass("visible")})}function $(e){a.find(".input-text, select, input:checkbox").trigger("validate").trigger("blur");let t=!1;const o=[],c=e=>{const c=r("#"+e.data("id")+"_field");if(c?.length){t||(t=c);const o=c.find(".woocommerce-error");o.length&&o.remove(),c.addClass("woocommerce-invalid").removeClass("woocommerce-valid"),c.append(`<span class="${s}__inline-error">`+e.text()+"</span>"),e.remove()}else e.is("li")||(e=r("<li />").append(e)),o.push(e)};if(m(),0!==e.trimStart().indexOf("<")?c(r("<li />").append(e)):e.includes("<li")?r(e).find("li").each(function(){c(r(this))}):c(r(e)),o.length){t=!1;const e=r('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout"/>').append(r('<ul class="woocommerce-error" role="alert" />').append(o));a.prepend(e),e.get(0).scrollIntoView({behavior:"smooth"})}t?.length&&(window.scroll({top:t.offset().top-100,left:0,behavior:"smooth"}),t.find("input.input-text, select, input:checkbox").trigger("focus")),P(a),r(document.body).trigger("update_checkout"),r(document.body).trigger("checkout_error",[e])}function O(e){e.preventDefault(),e.stopImmediatePropagation(),B(),i("continue")}function N(e){const t=window.newspack_grecaptcha||{};if(m(),r("#checkout_details").remove(),e)a.attr("data-skip-recaptcha","1"),a.append('<input name="is_validation_only" type="hidden" value="1" />'),"v3"===t?.version&&t.destroy(a.get()),g.length&&g.hide(),w.length&&w.hide(),b.show(),y.hide(),b.find("input").first().focus(),c=function(e,t){const o=r._data(e,"events");return o?t?o[t]||[]:o:[]}(a[0],"submit").slice(0),c.forEach(e=>{a.off("submit",e.handler)}),a.on("submit",O);else{a.removeAttr("data-skip-recaptcha");const e=a.find('[name="is_validation_only"]');if(e.length&&e.remove(),t?.render){a.data("newspack-recaptcha","newspack_modal_checkout");const e=()=>{m(),a.get(0).scrollIntoView({behavior:"smooth"})},o=e=>$(e);t.render(a.get(),e,o),r(document).on("updated_checkout",()=>t.render(a.get(),e,o)),r(document.body).on("checkout_error",()=>t.render(a.get(),e,o))}g.length&&g.show(),w.length&&w.show(),b.hide(),y.show(),function(){r("#checkout_details").remove();const e={};a.serializeArray().forEach(t=>{e[t.name]=t.value});const t=`${newspackBlocksModalCheckout.newspack_class_prefix}__font--xs`,o=[];o.push('<div class="billing-details">'),o.push("<h3>"+newspackBlocksModalCheckout.labels.billing_details+"</h3>"),(e.billing_first_name||e.billing_last_name)&&o.push(`<p class="${t}">`+e.billing_first_name+" "+e.billing_last_name+"</p>"),e.billing_company&&o.push(`<p class="${t}">`+e.billing_company+"</p>");let c="";if((e.billing_address_1||e.billing_address_2)&&(c=`<p class="${t}">`,e.billing_address_1&&(c+=e.billing_address_1),e.billing_address_2&&(c+=" "+e.billing_address_2),c+="<br>",e.billing_city&&(c+=e.billing_city),e.billing_state&&(c+=", "+e.billing_state),e.billing_postcode&&(c+=" "+e.billing_postcode),c+="<br>",e.billing_country&&(c+=e.billing_country)),o.push(c),e.billing_email&&o.push(`<p class="${t}">`+e.billing_email+"</p>"),o.push("</div>"),e.hasOwnProperty("shipping_address_1")){o.push('<div class="shipping-details">'),o.push("<h3>"+newspackBlocksModalCheckout.labels.shipping_details+"</h3>");let n="";e.ship_to_different_address?(n=`<p class="${t}">`,e.shipping_address_1&&(n+=e.shipping_address_1),e.shipping_address_2&&(n+=" "+e.shipping_address_2),n+="<br>",e.shipping_city&&(n+=e.shipping_city),e.shipping_state&&(n+=", "+e.shipping_state),e.shipping_postcode&&(n+=" "+e.shipping_postcode),n+="<br>",e.shipping_country&&(n+=e.shipping_country)):n=c,o.push(n),o.push("</div>")}e.hasOwnProperty("newspack_wcsg_is_gift")&&e.hasOwnProperty("wcsg_gift_recipients_email")&&e.newspack_wcsg_is_gift&&e.wcsg_gift_recipients_email&&(o.push('<div class="gift-details">'),o.push("<h3>"+newspackBlocksModalCheckout.labels.gift_recipient+"</h3>"),o.push(`<p class="${t}">`+e.wcsg_gift_recipients_email+"</p>")),r(".order-details-summary").after('<div id="checkout_details">'+o.join("")+"</div>")}(),a.off("submit",O),c.forEach(e=>{a.on("submit",e.handler)}),k()}a.triggerHandler("editing_details",[e]),window.scroll({top:0,left:0,behavior:"smooth"})}function B(e=!1,t=()=>{}){if(!L(a))return console.warn("Unable to block the form"),t(),!1;m();const o=a.find(".woocommerce-NoticeGroup.woocommerce-NoticeGroup-checkout");o.length&&o.remove();const c=["save_user_in_woopay"],n=a.serializeArray().filter(e=>!c.includes(e.name));n.push({name:"woocommerce_checkout_update_totals",value:"1"}),r.ajax({type:"POST",url:wc_checkout_params.checkout_url,data:n,dataType:"html",success:o=>{let c;try{c=JSON.parse(o)}catch(e){c={messages:'<div class="woocommerce-error">'+wc_checkout_params.i18n_checkout_error+"</div>"}}e||!0!==c.reload?(P(a),c.messages?e||(c.messages?$(c.messages):$(`<div class="${s}__inline-error">`+wc_checkout_params.i18n_checkout_error+"</div>")):(N(!1),r._data(a[0],"events")?.click?.some(e=>"#checkout_edit_billing"===e.selector)||a.on("click","#checkout_edit_billing",function(e){e.preventDefault(),N(!0),i("back")})),t(c)):window.location.reload()},error:(o,c,n)=>{let i="";e||(i='<div class="woocommerce-error">'+(n||wc_checkout_params.i18n_checkout_error)+"</div>",$(i)),t({messages:i})}})}function L(e){return!e.is(".modal-processing")&&(e.find("button[type=submit]").each((e,t)=>{r(t).attr("disabled",!0)}),e.addClass("modal-processing"),!0)}function P(e){return!!e.is(".modal-processing")&&(e.find("button[type=submit]").each((e,t)=>{r(t).attr("disabled",!1)}),e.removeClass("modal-processing"),!0)}v.length?(N(!0),C.length?f():B(!0,f)):f(),g.length&&(g.on("submit",function(e){if(e.preventDefault(),!L(g))return!1;const t={security:wc_checkout_params.apply_coupon_nonce,coupon_code:g.find('input[name="coupon_code"]').val()};r.ajax({type:"POST",url:wc_checkout_params.wc_ajax_url.toString().replace("%%endpoint%%","apply_coupon"),data:t,dataType:"html",success:e=>{if(m(),g.find(".result").remove(),e){const o=e.includes("error");g.append(`<p class="result ${s}__helper-text ${o?s+"__inline-error":""}">`+r(e).text()+"</p>"),o?(g.find('input[name="coupon_code"]').focus(),g.find('h3, input[name="coupon_code"]').addClass("newspack-ui__field-error")):(g.find('input[name="coupon_code"]').focus(),g.find('h3, input[name="coupon_code"]').removeClass("newspack-ui__field-error")),r(document.body).trigger("applied_coupon_in_checkout",[t.coupon_code]),r(document.body).trigger("update_checkout",{update_shipping_method:!1})}},complete:()=>{P(g)}})}),r(document.body).on("removed_coupon_in_checkout",()=>{m(),g.find(".result").remove(),g.find('input[name="coupon_code"]').val("").focus()})),w.length&&w.on("submit",function(e){if(e.preventDefault(),!L(w))return!1;const t=w.find('input[name="price"]');t.attr("disabled",!0);const o={_ajax_nonce:newspackBlocksModalCheckout.nyp_nonce,action:"process_name_your_price_request",price:w.find('input[name="price"]').val(),product_id:w.find('input[name="product_id"]').val(),newspack_checkout_name_your_price:w.find('input[name="newspack_checkout_name_your_price"]').val()};r.ajax({type:"POST",url:newspackBlocksModalCheckout.ajax_url,data:o,success:({success:e,data:t})=>{m(),w.find(".result").remove(),w.append(`<p class="result ${s}__helper-text ${e?"":s+"__inline-error"}">`+t.message+"</p>"),e?w.find('h3, input[name="price"]').removeClass("newspack-ui__field-error"):(w.find('input[name="price"]').focus(),w.find('h3, input[name="price"]').addClass("newspack-ui__field-error")),r(document.body).trigger("update_checkout",{update_shipping_method:!1})},complete:()=>{P(w),t.attr("disabled",!1),t.focus()}})}),a.on("click","#place_order",function(){(()=>{if("function"!=typeof window.gtag)return;const t=n("modal-checkout-product-details"),c=e("form_submission",t);o(c)})()});const S=function(){if(!t)return;const e="data-newspack-error-handled",o=o=>{o.hasAttribute(e)||(o.setAttribute(e,"true"),r(o).addClass(`${s}__notice ${s}__notice--error`),t.dispatchEvent(_),o.scrollIntoView({behavior:"smooth",block:"center"}))},c=e=>!!e.classList?.contains("woocommerce-error")||!(!e.classList?.contains("wc-block-components-notice-banner")||!e.classList?.contains("is-error")),n=new MutationObserver(e=>{for(const t of e)for(const e of t.addedNodes){if(e.nodeType!==Node.ELEMENT_NODE)continue;if(c(e))return void o(e);const t=e.querySelector?.(".woocommerce-error, .wc-block-components-notice-banner.is-error");if(t)return void o(t)}});return n.observe(t,{childList:!0,subtree:!0}),n}();if(S){const e=()=>S.disconnect();t.addEventListener("checkout-complete",e),t.addEventListener("checkout-cancel",e),window.addEventListener("beforeunload",e)}}g()}function k(){const e=r("#newspack_subscription_terms_confirmation, #newspack_subscription_confirmation");if(e.length){const t=r("form.checkout"),o=t.find("button#place_order, button#place_order_clone");function c(){const t=e.is(":checked");o.each((e,o)=>{r(o).attr("disabled",!t)})}c(),e.on("change",c),t.on("submit",function(t){if(!e.is(":checked"))return t.preventDefault(),t.stopPropagation(),!1})}}r(document.body).on("updated_checkout payment_method_selected checkout_error",k),r(document).ready(k),r(document.body).on("checkout_error",function(){const e=r(".woocommerce-NoticeGroup-checkout, .woocommerce-notices-wrapper");e.length&&e.each((e,t)=>r(t).addClass(`${s}__notice ${s}__notice--error`));const t=r("#checkout_error_back");t.length&&t.on("click",e=>{e.preventDefault(),parent.newspackCloseModalCheckout()}),f(!1)}),document.addEventListener("keydown",function(e){"Escape"===e.key&&parent.newspackCloseModalCheckout()}),newspackBlocksModalCheckout.is_error&&r(document.body).trigger("checkout_error")})})();