(()=>{"use strict";var e;(e=jQuery)&&(e("#newspack-group-subscription").on("change","input#_newspack_group_subscription_enabled",function(s){const r=e(s.currentTarget).closest("#newspack-group-subscription");e(s.currentTarget).is(":checked")?r.addClass("enabled"):r.removeClass("enabled")}),e("#newspack-group-subscription").on("change","#_newspack_group_subscription_member_ids",function(s){s.preventDefault();const r=e(s.currentTarget);r.attr("disabled",!0);const n=r.closest(".newspack-group-subscription--container").data("subscription-id"),a=r.val();a&&n&&fetch(`${newspackGroupSubscriptions.apiUrl}/members`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":newspackGroupSubscriptions.apiNonce},body:JSON.stringify({subscription_id:n,members_to_add:[a]})}).then(e=>e.json()).then(s=>{if(s.code&&s.message&&"abort"!==s.message)throw new Error(s.message);if(s.members_added?.[a]){const n=e(".newspack-group-subscription--members-list"),o=r.closest(".newspack-group-subscription--container").find(".newspack-group-subscription--members-count");o.length&&o.text(parseInt(o.text())+1),n.append('<li><a class="newspack-group-subscription--member-user-link" href="#"></a><a href="#" class="newspack-group-subscription--remove-member">&#215; <span class="screen-reader-text">Remove</span></a></li>');const t=n.find("li").last();t.find(".newspack-group-subscription--member-user-link").text(s.members_added[a].email).attr("href",s.members_added[a].url),t.find(" .newspack-group-subscription--remove-member").data("user-id",a)}}).catch(e=>{r.before('<mark class="error"><span class="dashicons dashicons-warning"></span><span class="message"></span></mark>'),r.parent().find(".message").text(e.message)}).finally(()=>{r.val(null).trigger("change"),r.attr("disabled",!1)})}),e("#newspack-group-subscription").on("click",".newspack-group-subscription--remove-member",function(s){s.preventDefault();const r=e(s.currentTarget),n=r.data("user-id"),a=r.closest(".newspack-group-subscription--container").data("subscription-id");if(!n||!a)return;const o=r.closest("li");o.addClass("newspack-group-subscription--to-remove"),o.find(".error").remove(),fetch(`${newspackGroupSubscriptions.apiUrl}/members`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":newspackGroupSubscriptions.apiNonce},body:JSON.stringify({subscription_id:a,members_to_remove:[n]})}).then(e=>e.json()).then(e=>{if(e.code&&e.message&&"abort"!==e.message)throw new Error(e.message);if(e.members_removed?.[n]){const e=o.closest(".newspack-group-subscription--members").find(".newspack-group-subscription--members-count");e.length&&e.text(parseInt(e.text())-1),o.remove()}}).catch(e=>{r.after('<mark class="error"><span class="dashicons dashicons-warning"></span><span class="message"></span></mark>'),r.parent().find(".message").text(e.message)}).finally(()=>{r.parent().removeClass("newspack-group-subscription--to-remove")})}),e(document).ready(function(){e("input#_newspack_group_subscription_enabled").trigger("change");const s=e("#_newspack_group_subscription_member_ids");s.select2({ajax:{url:`${newspackGroupSubscriptions.apiUrl}/search-users`,beforeSend(e){e.setRequestHeader("X-WP-Nonce",newspackGroupSubscriptions.apiNonce)},type:"POST",delay:2e3,data(e){const r=s.closest(".newspack-group-subscription--container").data("subscription-id");return{search:e.term,subscription_id:r}},processResults:e=>({results:e}),error(e,r,n){const a=e.responseJSON?.message||n;"abort"!==a&&s.before(`<mark class="error"><span class="dashicons dashicons-warning"></span>${a}</mark>`)},cache:!0},closeOnSelect:!0,minimumInputLength:2,placeholder:newspackGroupSubscriptions.placeholder,allowClear:!0}),s.on("select2:opening",function(){s.parent().find(".error").remove()})}))})();