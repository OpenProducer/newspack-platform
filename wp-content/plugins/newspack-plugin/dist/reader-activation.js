(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{authenticateOTP:()=>R,default:()=>q,dispatchActivity:()=>g,getActivities:()=>m,getAuthStrategy:()=>I,getCaptchaToken:()=>T,getOTPHash:()=>O,getReader:()=>S,getUniqueActivitiesBy:()=>y,hasAuthLink:()=>E,refreshAuthentication:()=>A,setAuthStrategy:()=>b,setAuthenticated:()=>k,setReaderEmail:()=>v,store:()=>_});const n={reader:"reader",data:"data",activity:"activity"},r=Object.values(n);function a(e){return r.includes(e)?`newspack-ras-${e}`:""}function i(e,t){if(!(e=a(e)))throw new Error("Invalid event");window.dispatchEvent(new CustomEvent(e,{detail:t}))}window.newspack_reader_data=window.newspack_reader_data||{};const o={storePrefix:newspack_reader_data?.store_prefix||"np_reader_",storage:window.localStorage,collections:{maxItems:1e3,maxAge:2592e6}},s=[];function c(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e)throw new Error("Key is required.");const n=[o.storePrefix];return t&&n.push("_"),n.push(e),n.join("")}function d(e){const t=w("unsynced",!0)||[];t.includes(e)||(t.push(e),f("unsynced",t,!0))}function u(e){return JSON.stringify(e)}function l(e){return e&&"string"==typeof e?JSON.parse(e):e}function w(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e)throw new Error("Key is required.");return l(o.storage.getItem(c(e,t)))}function f(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e)throw new Error("Key is required.");if(null==t)throw new Error("Value cannot be undefined or null.");if("_"===e[0])throw new Error("Key cannot start with an underscore.");o.storage.setItem(c(e,r),u(t)),r||i(n.data,{key:e,value:t})}function h(e){if(!e)return"";const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?decodeURIComponent(t.pop().split(";").shift()):void 0}function p(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:365;const r=new Date;r.setTime(r.getTime()+24*n*60*60*1e3),document.cookie=`${e}=${t}; expires=${r.toUTCString()}; path=/`}setInterval((()=>{if(!s.length)return;const e=s.shift();(function(e){if(!e)return Promise.reject("Key is required.");if(!newspack_reader_data.api_url||!newspack_reader_data.nonce)return Promise.reject("API not available.");const t=w(e),n={key:e};t&&(n.value=JSON.stringify(t));const r=new XMLHttpRequest;return r.open(n.value?"POST":"DELETE",newspack_reader_data.api_url,!0),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("X-WP-Nonce",newspack_reader_data.nonce),r.send(JSON.stringify(n)),new Promise(((e,t)=>{r.onreadystatechange=()=>{if(4===r.readyState)return 200!==r.status?t(r):e(r)}}))})(e).then((()=>function(e){const t=w("unsynced",!0)||[];t.includes(e)&&(t.splice(t.indexOf(e),1),f("unsynced",t,!0))}(e))).catch((()=>d(e)))}),1e3),window.newspack_ras_config=window.newspack_ras_config||{};const _=function(){const e=w("unsynced",!0)||[];for(const t of e)s.push(t);if(newspack_reader_data?.items){const t=Object.keys(newspack_reader_data.items);for(const n of t)e.includes(n)||f(n,JSON.parse(newspack_reader_data.items[n]))}return{get:e=>{if(!e)throw new Error("Key is required.");return w(e)},set:function(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];f(e,t,!1),n&&(d(e),s.push(e))},delete:e=>{if(!e)throw new Error("Key is required.");o.storage.removeItem(c(e)),i(n.data,{key:e,value:void 0}),d(e),s.push(e)},add:(e,t)=>{if(!e)throw new Error("Key cannot be empty.");if(!t)throw new Error("Value cannot be empty.");let n=w(e)||[];if(!Array.isArray(n))throw new Error(`Store key '${e}' is not an array.`);if(o.collections.maxAge){const e=Date.now();n=n.filter((t=>!t.timestamp||e-t.timestamp<o.collections.maxAge))}n.push(t),n=n.slice(-o.collections.maxItems),f(e,n)}}}();function g(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const a={action:e,data:t,timestamp:r||Date.now()};return _.add("activity",a),i(n.activity,a),a}function m(e){const t=_.get("activity")||[];return e?t.filter((t=>t.action===e)):t}function y(e,t){const n=m(e),r=[],a={};for(const e of n){const n="function"==typeof t?t(e):e.data[t];a[n]||(r.push(e),a[n]=!0)}return r}function v(e){if(!e)return;const t=S();t.email=e,_.set("reader",t,!1),i(n.reader,t)}function k(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=_.get("reader")||{};if(!t.email)throw new Error("Reader email not set");t.authenticated=Boolean(e),_.set("reader",t,!1),i(n.reader,t)}function A(){const e=h("np_auth_reader");e?(v(e),k(!0)):v(h("np_auth_intention"))}function S(){return _.get("reader")||{}}function E(){const e=S(),t=h("np_auth_link");return!(!e?.email||!t)}const P=["pwd","link"];function O(){return h("np_otp_hash")}function R(e){return new Promise(((t,n)=>{const r=O(),a=S()?.email;return r?a?e?void fetch("",{method:"POST",headers:{Accept:"application/json"},body:new URLSearchParams({action:newspack_ras_config.otp_auth_action,email:a,hash:r,code:e})}).then((e=>e.json())).then((e=>{let{success:r,message:i,data:o}=e;const s={...o,email:a,authenticated:!!r,message:i};k(!!r),r?t(s):n(s)})):n({message:"Invalid code"}):n({message:"You must provide an email"}):n({message:"Code has expired",expired:!0})}))}function b(e){if(!P.includes(e))throw new Error("Invalid authentication strategy");return p("np_auth_strategy",e),e}function I(){return O()?"otp":h("np_auth_strategy")}function T(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"submit";return new Promise(((t,n)=>{const{grecaptcha:r}=window;if(!r||!newspack_ras_config)return t("");const{captcha_site_key:a}=newspack_ras_config;if(!a)return t("");r?.ready||n("Error loading the reCaptcha library."),r.ready((()=>{r.execute(a,{action:e}).then((e=>t(e))).catch((e=>n(e)))}))}))}const j={store:_,on:function(e,t){if(!(e=a(e)))throw new Error("Invalid event");window.addEventListener(e,t)},off:function(e,t){if(!(e=a(e)))throw new Error("Invalid event");window.removeEventListener(e,t)},dispatchActivity:g,getActivities:m,getUniqueActivitiesBy:y,setReaderEmail:v,setAuthenticated:k,refreshAuthentication:A,getReader:S,hasAuthLink:E,getOTPHash:O,authenticateOTP:R,setAuthStrategy:b,getAuthStrategy:I,getCaptchaToken:T};function x(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t.forEach((e=>{Array.isArray(e)&&"string"==typeof e[0]?g(...e):"function"==typeof e?e(j):console.warn("Invalid newspackRAS.push argument",e)}))}window.newspackRASInitialized||function(){const e=newspack_ras_config,t=e?.authenticated_email||h("np_auth_intention"),r=!!e?.authenticated_email,a=S(),o={email:t||a?.email,authenticated:r};var s;a?.email===o?.email&&a?.authenticated===o?.authenticated||_.set("reader",o,!1),i(n.reader,o),function(){const e=newspack_ras_config.cid_cookie;h(e)||p(e,function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,t="";const n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(let r=0;r<e;r++){const e=Math.floor(Math.random()*n.length);t+=n.charAt(e)}return t}(12))}(),(s=j).on("activity",(e=>{let{detail:{action:t,data:n,timestamp:r}}=e;if("article_view"!==t)return;const a=new Date(r);a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0);const i=6-a.getDay();a.setDate(a.getDate()+i);const o=a.getTime(),c=s.store.get("article_view_per_week")||{};c[o]||(c[o]={}),c[o][n.post_id]=!0,s.store.set("article_view_per_week",c),a.setMonth(a.getMonth()+1),a.setDate(1);const d=a.getTime(),u=s.store.get("article_view_per_month")||{};u[d]||(u[d]={}),u[d][n.post_id]=!0,s.store.set("article_view_per_month",u)})),function(){if(h("np_auth_reader"))return;const e=setInterval((()=>{const t=S(),n=h("np_auth_intention");if(n&&t.email!==n)v(n);else{const t=h("np_auth_reader");t&&(v(t),k(!0),clearInterval(e))}}),1e3)}(),(newspack_reader_data?.reader_activity||[]).forEach((e=>{let{action:t,data:n}=e;return g(t,n)})),function(){const e=document.referrer?new URL(document.referrer).hostname:"";e&&e!==window.location.hostname&&_.set("referrer",e.replace("www.","").trim().toLowerCase())}(),window.newspackReaderActivation=j,window.newspackRAS=window.newspackRAS||[],window.newspackRAS.forEach((e=>x(e))),window.newspackRAS.push=x,window.newspackRASInitialized=!0}();const q=j;var M=window;for(var C in t)M[C]=t[C];t.__esModule&&Object.defineProperty(M,"__esModule",{value:!0})})();