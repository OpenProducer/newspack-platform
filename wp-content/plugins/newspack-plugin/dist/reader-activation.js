!function(){"use strict";var e={d:function(t,n){for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r:function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{authenticateOTP:function(){return T},default:function(){return C},dispatchActivity:function(){return v},getActivities:function(){return k},getAuthStrategy:function(){return j},getCaptchaToken:function(){return q},getOTPHash:function(){return I},getReader:function(){return O},getUniqueActivitiesBy:function(){return A},hasAuthLink:function(){return P},refreshAuthentication:function(){return b},setAuthStrategy:function(){return x},setAuthenticated:function(){return E},setReaderEmail:function(){return S},store:function(){return y}});const n={reader:"reader",data:"data",activity:"activity",overlay:"overlay"},r=Object.values(n);function a(e){return r.includes(e)?`newspack-ras-${e}`:""}function o(e,t){if(!(e=a(e)))throw new Error("Invalid event");window.dispatchEvent(new CustomEvent(e,{detail:t}))}window.newspack_reader_data=window.newspack_reader_data||{};const i={storePrefix:newspack_reader_data?.store_prefix||"np_reader_",storage:newspack_reader_data?.is_temporary?window.sessionStorage:window.localStorage,collections:{maxItems:1e3,maxAge:2592e6}},s=[];function c(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e)throw new Error("Key is required.");const n=[i.storePrefix];return t&&n.push("_"),n.push(e),n.join("")}function u(e){const t=l("unsynced",!0)||[];t.includes(e)||(t.push(e),w("unsynced",t,!0))}function d(e){return JSON.stringify(e)}function f(e){return e&&"string"==typeof e?JSON.parse(e):e}function l(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e)throw new Error("Key is required.");return f(i.storage.getItem(c(e,t)))}function w(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e)throw new Error("Key is required.");if(null==t)throw new Error("Value cannot be undefined or null.");if("_"===e[0])throw new Error("Key cannot start with an underscore.");i.storage.setItem(c(e,r),d(t)),r||o(n.data,{key:e,value:t})}function h(e){if(!e)return"";const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?decodeURIComponent(t.pop().split(";").shift()):void 0}function p(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:365;const r=new Date;r.setTime(r.getTime()+24*n*60*60*1e3),document.cookie=`${e}=${t}; expires=${r.toUTCString()}; path=/`}function _(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,t="";const n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(let r=0;r<e;r++){const e=Math.floor(Math.random()*n.length);t+=n.charAt(e)}return t}setInterval((()=>{if(!s.length||newspack_reader_data?.is_temporary)return;const e=s.shift();(function(e){if(!e)return Promise.reject("Key is required.");if(!newspack_reader_data.api_url||!newspack_reader_data.nonce)return Promise.reject("API not available.");const t=l(e),n={key:e};t&&(n.value=JSON.stringify(t));const r=new XMLHttpRequest;return r.open(n.value?"POST":"DELETE",newspack_reader_data.api_url,!0),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("X-WP-Nonce",newspack_reader_data.nonce),r.send(JSON.stringify(n)),new Promise(((e,t)=>{r.onreadystatechange=()=>{if(4===r.readyState)return 200!==r.status?t(r):e(r)}}))})(e).then((()=>function(e){const t=l("unsynced",!0)||[];t.includes(e)&&(t.splice(t.indexOf(e),1),w("unsynced",t,!0))}(e))).catch((()=>u(e)))}),1e3);const m=[];var g={get:function(){return m||[]},add:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e||(e=_()),m.push(e),o(n.overlay,{overlays:m}),e},remove:function(e){if(!e)return m;const t=m.indexOf(e);return t>-1&&m.splice(t,1),o(n.overlay,{overlays:m}),m}};window.newspack_ras_config=window.newspack_ras_config||{};const y=function(){const e=l("unsynced",!0)||[];for(const t of e)s.push(t);if(newspack_reader_data?.items&&!newspack_reader_data?.is_temporary){const t=Object.keys(newspack_reader_data.items);for(const n of t)e.includes(n)||w(n,JSON.parse(newspack_reader_data.items[n]))}return{get:e=>{if(!e)throw new Error("Key is required.");return l(e)},set:function(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];w(e,t,!1),n&&(u(e),s.push(e))},delete:e=>{if(!e)throw new Error("Key is required.");i.storage.removeItem(c(e)),o(n.data,{key:e,value:void 0}),u(e),s.push(e)},add:(e,t)=>{if(!e)throw new Error("Key cannot be empty.");if(!t)throw new Error("Value cannot be empty.");let n=l(e)||[];if(!Array.isArray(n))throw new Error(`Store key '${e}' is not an array.`);if(i.collections.maxAge){const e=Date.now();n=n.filter((t=>!t.timestamp||e-t.timestamp<i.collections.maxAge))}n.push(t),n=n.slice(-i.collections.maxItems),w(e,n)}}}();function v(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const a={action:e,data:t,timestamp:r||Date.now()};return y.add("activity",a),o(n.activity,a),a}function k(e){const t=y.get("activity")||[];return e?t.filter((t=>t.action===e)):t}function A(e,t){const n=k(e),r=[],a={};for(const e of n){const n="function"==typeof t?t(e):e.data[t];a[n]||(r.push(e),a[n]=!0)}return r}function S(e){if(!e)return;const t=O();t.email=e,y.set("reader",t,!1),o(n.reader,t)}function E(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=y.get("reader")||{};if(!t.email)throw new Error("Reader email not set");t.authenticated=Boolean(e),y.set("reader",t,!1),o(n.reader,t)}function b(){const e=h("np_auth_reader");e?(S(e),E(!0)):S(h("np_auth_intention"))}function O(){return y.get("reader")||{}}function P(){const e=O(),t=h("np_auth_link");return!(!e?.email||!t)}const R=["pwd","link"];function I(){return h("np_otp_hash")}function T(e){return new Promise(((t,n)=>{const r=I(),a=O()?.email;return r?a?e?void fetch("",{method:"POST",headers:{Accept:"application/json"},body:new URLSearchParams({action:newspack_ras_config.otp_auth_action,email:a,hash:r,code:e})}).then((e=>e.json())).then((e=>{let{success:r,message:o,data:i}=e;const s={...i,email:a,authenticated:!!r,message:o};E(!!r),r?t(s):n(s)})):n({message:"Invalid code"}):n({message:"You must provide an email"}):n({message:"Code has expired",expired:!0})}))}function x(e){if(!R.includes(e))throw new Error("Invalid authentication strategy");return p("np_auth_strategy",e),e}function j(){return I()?"otp":h("np_auth_strategy")}function q(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"submit";return new Promise(((t,n)=>{const{grecaptcha:r}=window;if(!r||!newspack_ras_config)return t("");const{captcha_site_key:a}=newspack_ras_config;if(!a)return t("");r?.ready||n("Error loading the reCaptcha library."),r.ready((()=>{r.execute(a,{action:e}).then((e=>t(e))).catch((e=>n(e)))}))}))}const M={store:y,overlays:g,on:function(e,t){if(!(e=a(e)))throw new Error("Invalid event");window.addEventListener(e,t)},off:function(e,t){if(!(e=a(e)))throw new Error("Invalid event");window.removeEventListener(e,t)},dispatchActivity:v,getActivities:k,getUniqueActivitiesBy:A,setReaderEmail:S,setAuthenticated:E,refreshAuthentication:b,getReader:O,hasAuthLink:P,getOTPHash:I,authenticateOTP:T,setAuthStrategy:x,getAuthStrategy:j,getCaptchaToken:q};function L(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t.forEach((e=>{Array.isArray(e)&&"string"==typeof e[0]?v(...e):"function"==typeof e?e(M):console.warn("Invalid newspackRAS.push argument",e)}))}window.newspackRASInitialized||function(){const e=newspack_ras_config,t=e?.authenticated_email||h("np_auth_intention"),r=!!e?.authenticated_email,a=O(),i={email:t||a?.email,authenticated:r};var s;a?.email===i?.email&&a?.authenticated===i?.authenticated||y.set("reader",i,!1),o(n.reader,i),function(){const e=newspack_ras_config.cid_cookie;h(e)||p(e,_(12))}(),(s=M).on("activity",(e=>{let{detail:{action:t,data:n,timestamp:r}}=e;if("article_view"!==t)return;const a=new Date(r);a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0);const o=6-a.getDay();a.setDate(a.getDate()+o);const i=a.getTime(),c=s.store.get("article_view_per_week")||{};c[i]||(c[i]={}),c[i][n.post_id]=!0,s.store.set("article_view_per_week",c),a.setMonth(a.getMonth()+1),a.setDate(1);const u=a.getTime(),d=s.store.get("article_view_per_month")||{};d[u]||(d[u]={}),d[u][n.post_id]=!0,s.store.set("article_view_per_month",d)})),function(){if(h("np_auth_reader"))return;const e=setInterval((()=>{const t=O(),n=h("np_auth_intention");if(n&&t.email!==n)S(n);else{const t=h("np_auth_reader");t&&(S(t),E(!0),clearInterval(e))}}),1e3)}(),function(){const e=document.querySelectorAll(".newspack-subscribe-form,.mc4wp-form");e.length&&e.forEach((e=>{"FORM"!==e.tagName&&(e=e.querySelector("form")),e&&e.addEventListener("submit",(()=>{y.set("is_newsletter_subscriber",!0)}))}))}(),(newspack_reader_data?.reader_activity||[]).forEach((e=>{let{action:t,data:n}=e;return v(t,n)})),function(){const e=document.referrer?new URL(document.referrer).hostname:"";e&&e!==window.location.hostname&&y.set("referrer",e.replace("www.","").trim().toLowerCase())}(),window.newspackReaderActivation=M,window.newspackRAS=window.newspackRAS||[],window.newspackRAS.forEach((e=>L(e))),window.newspackRAS.push=L,window.newspackRASInitialized=!0}();var C=M,D=window;for(var K in t)D[K]=t[K];t.__esModule&&Object.defineProperty(D,"__esModule",{value:!0})}();